name: Deploy Documentation

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper git operations

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install DocFX
      run: dotnet tool install -g docfx

    - name: Build solution
      run: dotnet build Gloam.slnx --configuration Release

    - name: Generate API documentation
      run: |
        cd docs
        docfx metadata

    - name: Build documentation site
      run: |
        cd docs
        docfx build --output _site

    - name: Add .nojekyll file
      run: touch docs/_site/.nojekyll

    - name: Create CNAME file (optional)
      run: |
        # Uncomment and modify if you have a custom domain
        # echo "docs.gloam.dev" > docs/_site/CNAME

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/_site

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Create release notes
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "ðŸ“š Documentation deployed for ${TAG_NAME}" >> release_notes.md
        echo "" >> release_notes.md
        echo "ðŸ”— View documentation: ${{ steps.deployment.outputs.page_url }}" >> release_notes.md
        echo "" >> release_notes.md
        echo "Changes in this release:" >> release_notes.md
        git log --oneline --pretty=format:"- %s" HEAD~1..HEAD >> release_notes.md

    - name: Upload release notes
      uses: actions/upload-artifact@v4
      with:
        name: release-notes
        path: release_notes.md
        retention-days: 30